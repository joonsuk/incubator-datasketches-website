<!DOCTYPE html>
<!-- Start _layouts/doc_page.html-->
<html lang="en">

<head>
  <!-- Start site_head.html include-->
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="datasketches">

<title>DataSketches | </title>

<link rel="shortcut icon" href="/img/favicon.png">

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

<link href='https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300,700,300italic|Open+Sans:300italic,400italic,600italic,400,300,600'
  rel='stylesheet' type='text/css'>

<link rel="stylesheet" href="/css/main.css">
<link rel="stylesheet" href="/css/header.css">
<link rel="stylesheet" href="/css/footer.css">
<link rel="stylesheet" href="/css/syntax.css">
<link rel="stylesheet" href="/css/docs.css">


<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full">
</script>
<script src="https://code.jquery.com/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
<!-- End site_head.html include-->

</head>

<body>
  <!-- Start page_header.html include -->
<div class="navbar navbar-inverse navbar-static-top ds-nav">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <!-- navbar-brand: https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css -->
      <!-- /css/main.css:57:.logo -->
      <a class="navbar-brand logo" href="/">DataSketches</a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
        <li>
          <a href="/overview.html">
            <span class="fa fa-info-circle"></span> OVERVIEW</a>
        </li>
        <li>
          <a href="/docs/downloads.html">
            <span class="fa fa-download"></span> DOWNLOAD</a>
        </li>
        <li>
          <a href="https://datasketches.github.io/README.html">
            <span class="fa fa-github"></span> GITHUB</a>
        </li>
        <li>
          <a href="/docs/Research.html">
            <span class="fa fa-paper-plane"></span> RESEARCH</a>
        </li>
        <li>
          <a href="https://groups.google.com/forum/#!forum/sketches-user">
            <span class="fa fa-comment"></span> FORUM</a>
        </li>

      </ul>
    </div>
  </div>
</div>
<!-- End page_header.html include -->


  <div class="ds-header">
    <div class="container">
      <h4>API Snapshots:
        <a href="/api/java/snapshot/apidocs/index.html">Java Core</a>,
        <a href="/api/memory/snapshot/apidocs/index.html">Memory</a>,
        <a href="/api/pig/snapshot/apidocs/index.html">Pig</a>,
        <a href="/api/hive/snapshot/apidocs/index.html">Hive</a>,
      </h4>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="col-md-3">
        <div class="searchbox" style="position:relative">
          <gcse:searchbox-only></gcse:searchbox-only>
        </div>
        <!-- Computer Generated File, Do Not Edit! -->
<link rel="stylesheet" href="/css/toc.css">
<div id="toc" class="nav toc hidden-print">

  <p id="overview">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_overview">Overview</a>
  </p>
  <div class="collapse" id="collapse_overview">
    <li><a href="/docs/TheChallenge.html">The Challenge</a></li>
    <li><a href="/docs/MajorSketchFamilies.html">The Major Sketch Families</a></li>
    <li><a href="/docs/SketchOrigins.html">Sketch Origins</a></li>
    <li><a href="/docs/SketchElements.html">Sketch Elements</a></li>
    <li><a href="/docs/KeyFeatures.html">Key Features</a></li>
    <li><a href="/docs/LargeScale.html">Large Scale Computing</a></li>
    <li><a href="/docs/Architecture.html">Architecture</a></li>
    <li><a href="/docs/OrderSensitivity.html">Notes on Order Sensitivity</a></li>
    <li><a href="/docs/Concurrency.html">Notes on Concurrency</a></li>
    <li><a href="https://github.com/DataSketches/DataSketches.github.io/blob/master/docs/pdf/DataSketches_deck.pdf">Overview Slide Deck</a></li>
  </div>

  <p id="research">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_research">Research</a>
  </p>
  <div class="collapse" id="collapse_research">
    <li><a href="/docs/Research.html">Research</a></li>
  </div>

  <p id="distinct-counting">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_distinct_counting">Distinct Counting</a>
  </p>
  <div class="collapse" id="collapse_distinct_counting">

    <p id="hyperloglog-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_hyperloglog_sketches">HyperLogLog Sketches</a>
    </p>
    <div class="collapse" id="collapse_hyperloglog_sketches">
      <li><a href="/docs/HLL/HLL.html">HLL Sketch</a></li>
      <li><a href="/docs/HLL/HllMap.html">HLL Map Sketch</a></li>

      <p id="hll-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_hll_examples">HLL Examples</a>
      </p>
      <div class="collapse" id="collapse_hll_examples">
        <li><a href="/docs/HLL/HllJavaExample.html">HLL Sketch Java Example</a></li>
        <li><a href="/docs/HLL/HllPigUDFs.html">HLL Sketch Pig UDFs</a></li>
        <li><a href="/docs/HLL/HllHiveUDFs.html">HLL Sketch Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>

      <p id="hll-studies">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_hll_studies">HLL Studies</a>
      </p>
      <div class="collapse" id="collapse_hll_studies">
        <li><a href="/docs/HLL/Hll_vs_Hllpp.html">HLL vs HLL++</a></li>
        <li><a href="/docs/HLL/HllSketchVsDruidHyperLogLogCollector.html">HLL Sketch vs Druid HyperLogLogCollector</a></li>
      </div>
    </div>

    <p id="theta-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_theta_sketches">Theta Sketches</a>
    </p>
    <div class="collapse" id="collapse_theta_sketches">
      <li><a href="/docs/Theta/ThetaSketchFramework.html">Theta Sketch Framework</a></li>

      <p id="theta-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_theta_examples">Theta Examples</a>
      </p>
      <div class="collapse" id="collapse_theta_examples">
        <li><a href="/docs/Theta/ConcurrentThetaSketch.html">Concurrent Theta Sketch</a></li>
        <li><a href="/docs/Theta/ThetaJavaExample.html">Theta Sketch Java Example</a></li>
        <li><a href="/docs/Theta/ThetaSparkExample.html">Theta Sketch Spark Example</a></li>
        <li><a href="/docs/Theta/ThetaPigUDFs.html">Theta Sketch Pig UDFs</a></li>
        <li><a href="/docs/Theta/ThetaHiveUDFs.html">Theta Sketch Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>

      <p id="kmv-tutorial">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_kmv_tutorial">KMV Tutorial</a>
      </p>
      <div class="collapse" id="collapse_kmv_tutorial">
        <li><a href="/docs/Theta/InverseEstimate.html">The Inverse Estimate</a></li>
        <li><a href="/docs/Theta/KMVempty.html">Empty Sketch</a></li>
        <li><a href="/docs/Theta/KMVfirstEst.html">First Estimator</a></li>
        <li><a href="/docs/Theta/KMVbetterEst.html">Better Estimator</a></li>
        <li><a href="/docs/Theta/KMVrejection.html">Rejection Rules</a></li>
        <li><a href="/docs/Theta/KMVupdateVkth.html">Update V(kth) Rule</a></li>
      </div>

      <p id="set-operations-and-p-sampling">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_set_operations_and_p-sampling">Set Operations and P-sampling</a>
      </p>
      <div class="collapse" id="collapse_set_operations_and_p-sampling">
        <li><a href="/docs/Theta/ThetaSketchSetOps.html">Set Operations</a></li>
        <li><a href="/docs/Theta/ThetaPSampling.html"><i>p</i>-Sampling</a></li>
      </div>

      <p id="accuracy">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_accuracy">Accuracy</a>
      </p>
      <div class="collapse" id="collapse_accuracy">
        <li><a href="/docs/Theta/ThetaAccuracy.html">Basic Accuracy</a></li>
        <li><a href="/docs/Theta/ThetaAccuracyPlots.html">Accuracy Plots</a></li>
        <li><a href="/docs/Theta/ThetaErrorTable.html">Relative Error Table</a></li>
        <li><a href="/docs/Theta/ThetaSketchSetOpsAccuracy.html">SetOp Accuracy</a></li>
        <li><a href="/docs/Theta/AccuracyOfDifferentKUnions.html">Unions With Different k</a></li>
      </div>

      <p id="size">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_size">Size</a>
      </p>
      <div class="collapse" id="collapse_size">
        <li><a href="/docs/Theta/ThetaSize.html">Theta Sketch Size</a></li>
      </div>

      <p id="speed">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_speed">Speed</a>
      </p>
      <div class="collapse" id="collapse_speed">
        <li><a href="/docs/Theta/ThetaUpdateSpeed.html">Update Speed</a></li>
        <li><a href="/docs/Theta/ThetaMergeSpeed.html">Merge Speed</a></li>
      </div>

      <p id="theta-sketch-theory">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_theta_sketch_theory">Theta Sketch Theory</a>
      </p>
      <div class="collapse" id="collapse_theta_sketch_theory">
        <li><a href="https://github.com/DataSketches/DataSketches.github.io/blob/master/docs/pdf/ThetaSketchFramework.pdf">Theta Sketch Framework (PDF)</a></li>
        <li><a href="https://github.com/DataSketches/DataSketches.github.io/blob/master/docs/pdf/SketchEquations.pdf">Sketch Equations (PDF)</a></li>
        <li><a href="https://github.com/DataSketches/DataSketches.github.io/blob/master/docs/pdf/DataSketches.pdf">DataSketches (PDF)</a></li>
        <li><a href="/docs/Theta/ThetaConfidenceIntervals.html">Confidence Intervals Notes</a></li>
        <li><a href="/docs/Theta/ThetaMergingAlgorithm.html">Merging Algorithm Notes</a></li>
        <li><a href="/docs/Theta/ThetaReferences.html">Theta References</a></li>
      </div>
    </div>

    <p id="tuple-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_tuple_sketches">Tuple Sketches</a>
    </p>
    <div class="collapse" id="collapse_tuple_sketches">
      <li><a href="/docs/Tuple/TupleOverview.html">Tuple Overview</a></li>

      <p id="tuple-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_tuple_examples">Tuple Examples</a>
      </p>
      <div class="collapse" id="collapse_tuple_examples">
        <li><a href="/docs/Tuple/TupleJavaExample.html">Tuple Java Example</a></li>
        <li><a href="/docs/Tuple/TupleEngagementExample.html">Tuple Engagement Example</a></li>
        <li><a href="/docs/Frequency/FrequentDistinctTuplesSketch.html">Frequent Distinct Tuples Sketch</a></li>
        <li><a href="/docs/Tuple/TuplePigUDFs.html">Tuple Pig UDFs</a></li>
        <li><a href="/docs/Tuple/TupleHiveUDFs.html">Tuple Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>
    </div>
  </div>

  <p id="most-frequent">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_most_frequent">Most Frequent</a>
  </p>
  <div class="collapse" id="collapse_most_frequent">
    <li><a href="/docs/Frequency/FrequencySketchesOverview.html">Frequency Sketches Overview</a></li>

    <p id="frequent-item-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_frequent_item_sketches">Frequent Item Sketches</a>
    </p>
    <div class="collapse" id="collapse_frequent_item_sketches">
      <li><a href="/docs/Frequency/FrequentItemsOverview.html">Frequent Items Overview</a></li>
      <li><a href="/docs/Frequency/FrequentItemsErrorTable.html">Frequent Items Error Table</a></li>
      <li><a href="/docs/Frequency/FrequentItemsReferences.html">Frequent Items References</a></li>

      <p id="most-frequent-examples">
        <a data-toggle="collapse" class="menu collapsed" href="#collapse_most_frequent_examples">Most Frequent Examples</a>
      </p>
      <div class="collapse" id="collapse_most_frequent_examples">
        <li><a href="/docs/Frequency/FrequentItemsJavaExample.html">Frequent Items Java Example</a></li>
        <li><a href="/docs/Frequency/FrequentItemsPigUDFs.html">Frequent Items Pig UDFs</a></li>
        <li><a href="/docs/Frequency/FrequentItemsHiveUDFs.html">Frequent Items Hive UDFs</a></li>
        <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
      </div>
    </div>

    <p id="frequent-distinct-sketches">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_frequent_distinct_sketches">Frequent Distinct Sketches</a>
    </p>
    <div class="collapse" id="collapse_frequent_distinct_sketches">
      <li><a href="/docs/Frequency/FrequentDistinctTuplesSketch.html">Frequent Distinct Tuples Sketch</a></li>
    </div>
  </div>

  <p id="quantiles-and-histograms">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_and_histograms">Quantiles And Histograms</a>
  </p>
  <div class="collapse" id="collapse_quantiles_and_histograms">
    <li><a href="/docs/Quantiles/QuantilesOverview.html">Quantiles Overview</a></li>
    <li><a href="/docs/Quantiles/QuantilesAccuracy.html">Quantiles Accuracy and Size</a></li>

    <p id="quantiles-examples">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_examples">Quantiles Examples</a>
    </p>
    <div class="collapse" id="collapse_quantiles_examples">
      <li><a href="/docs/Quantiles/QuantilesJavaExample.html">Quantiles Sketch Java Example</a></li>
      <li><a href="/docs/Quantiles/QuantilesPigUDFs.html">Quantiles Sketch Pig UDFs</a></li>
      <li><a href="/docs/Quantiles/QuantilesHiveUDFs.html">Quantiles Sketch Hive UDFs</a></li>
      <li><a href="/docs/DruidIntegration.html">Using Sketches in Druid</a></li>
    </div>

    <p id="quantiles-studies">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_studies">Quantiles Studies</a>
    </p>
    <div class="collapse" id="collapse_quantiles_studies">
      <li><a href="/docs/Quantiles/KLLSketch.html">New KLL sketch and comparison with DoublesSketch</a></li>
      <li><a href="/docs/Quantiles/KllSketchVsTDigest.html">KLL sketch vs t-digest</a></li>
      <li><a href="/docs/Quantiles/DruidApproxHistogramStudy.html">Druid Approximate Histogram</a></li>
      <li><a href="/docs/Quantiles/MomentsSketchStudy.html">Moments Sketch Study</a></li>
      <li><a href="/docs/Quantiles/QuantilesStreamAStudy.html">Quantiles StreamA Study</a></li>
    </div>

    <p id="quantiles-sketch-theory">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_quantiles_sketch_theory">Quantiles Sketch Theory</a>
    </p>
    <div class="collapse" id="collapse_quantiles_sketch_theory">
      <li><a href="https://github.com/DataSketches/DataSketches.github.io/blob/master/docs/pdf/Quantiles_KLL.pdf">Optimal Quantile Approximation in Streams</a></li>
      <li><a href="/docs/Quantiles/QuantilesReferences.html">Quantiles References</a></li>
    </div>
  </div>

  <p id="sampling">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_sampling">Sampling</a>
  </p>
  <div class="collapse" id="collapse_sampling">
    <li><a href="/docs/Sampling/ReservoirSampling.html">Reservoir Sampling</a></li>
    <li><a href="/docs/Sampling/ReservoirSamplingPerformance.html">Reservoir Sampling Performance</a></li>
    <li><a href="/docs/Sampling/VarOptSampling.html">VarOpt Sampling</a></li>

    <p id="sampling-examples">
      <a data-toggle="collapse" class="menu collapsed" href="#collapse_sampling_examples">Sampling Examples</a>
    </p>
    <div class="collapse" id="collapse_sampling_examples">
      <li><a href="/docs/Sampling/ReservoirSamplingJava.html">Reservoir Sampling Java Example</a></li>
      <li><a href="/docs/Sampling/ReservoirSamplingPigUDFs.html">Reservoir Sampling Pig UDFs</a></li>
      <li><a href="/docs/Sampling/VarOptSamplingJava.html">VarOpt Sampling Java Example</a></li>
      <li><a href="/docs/Sampling/VarOptPigUDFs.html">VarOpt Sampling Pig UDFs</a></li>
    </div>
  </div>

  <p id="memory-package">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_memory_package">Memory Package</a>
  </p>
  <div class="collapse" id="collapse_memory_package">
    <li><a href="/docs/Memory/MemoryPackage.html">Memory Package</a></li>
    <li><a href="/docs/Memory/MemoryPerformance.html">Memory Package Performance</a></li>
  </div>

  <p id="command-line">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_command_line">Command Line</a>
  </p>
  <div class="collapse" id="collapse_command_line">
    <li><a href="/docs/CommandLine/CommandLine.html">Creating Command Line Executables</a></li>
  </div>

  <p id="who-uses">
    <a data-toggle="collapse" class="menu collapsed" href="#collapse_who_uses">Who Uses</a>
  </p>
  <div class="collapse" id="collapse_who_uses">
    <li><a href="/docs/WhoUses.html">Who Uses</a></li>
  </div>
</div>
<script>
  (function () {

    var findLineItem = function (path) {
      return document.querySelector(`[href="${path}"]`);
    };

    var highlighLineItem = function (element) {
      element.classList.add('highlight');
    };

    var checkHasClass = function (element, className) {
      return element.className.split(' ').find(function (item) { return item === className || '' })
    }

    var findAllCollapseParents = function (element) {
      var collapseMenus = [];
      var elementPointer = element;
      while (elementPointer !== document.body) {
        if (checkHasClass(elementPointer, 'collapse')) {
          collapseMenus.push(elementPointer);
        }
        elementPointer = elementPointer.parentElement
      }
      return collapseMenus
    };

    var findMatchingCollapseMenu = function (collapseItem) {
      return document.querySelector(`[href="#${collapseItem.id}"]`);
    };

    var findAllParentMenus = function (element) {
      var parentMenus = []
      var elementPointer = element;
      while (elementPointer !== document.body) {
        if (elementPointer.className.split(' ').indexOf('menu') > -1) {
          parentMenus.push(elementPointer);
        }
        elementPointer = elementPointer.parentElement;
      }
      return parentMenus;
    }

    var openMenuItem = function (element) {
      element.click();
    };

    var openAllFromList = function (elementList) {
      elementList.forEach(function (element) {
        console.log(element)
        openMenuItem(findMatchingCollapseMenu(element))
      });
    };

    var highlightAndOpenMenu = function () {
      var currentLineItem = findLineItem(document.location.pathname);
      highlighLineItem(currentLineItem)
      openAllFromList(findAllCollapseParents(currentLineItem));
    };

    $(highlightAndOpenMenu);

  }());
</script>


      </div>
      <div class="col-md-9 doc-content">
        <a class="btn btn-default btn-xs visible-xs-inline-block visible-sm-inline-block" href="/docs/toc.html">Table of Contents</a>
        <!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<h1 id="quantiles-sketch-overview">Quantiles Sketch Overview</h1>

<p>This is a stochastic streaming sketch that enables near-real time analysis of the 
approximate distribution of comparable values from a very large stream in a single pass. 
The analysis is obtained using a getQuantiles() function or its inverse functions the 
Probability Mass Function from getPMF() and the Cumulative Distribution Function from getCDF().</p>

<h3 id="section-links">Section links:</h3>
<ul>
  <li><a href="#Section 1">Section 1</a> Sketches-Core Numeric Quantiles</li>
  <li><a href="#Section 2">Section 2</a> Sketches-Core Extending Generic Quantiles Classes</li>
  <li><a href="#Section 3">Section 3</a> Implementation Notes</li>
</ul>

<h2 id="sketches-core-numeric-quantiles"><a name="Section 1"></a>Sketches-Core Numeric Quantiles</h2>

<p>Consider this real data example of a stream of 230 million time-spent events collected from one our systems for a period of just 30 minutes. Each event records the amount of time in milliseconds that a user spends on a web page before moving to a different web page by taking some action, such as a click.</p>

<p>An exact, brute-force approach to computing an arbitrary quantile would require creating a sorted list all 230 million values and then choosing an index into this list for the desired quantile. This index is the <em>absolute rank</em> of the values in the sorted list and in this case would vary from zero to 230 million. The value at rank = 115M is the median or 50th percentile;  <em>normalized Rank</em> is computed by dividing the <em>absolute rank</em> by the size of the list, which produces a fraction between zero and one.  Quantiles are <em>values</em> corresponding to a <em>normalized rank</em>. Thus, the median value = quantile(0.5). The quantile(0.95) is the value from the stream at the <em>absolute rank</em> (index) position (0.95) X 230M, which means only 5% of all the values from the stream are equal to or larger than this value.</p>

<p>The relevant pseudo-code snippets would look something like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int k = 256; //256 gives &lt; 1% normalized rank error
UpdateDoublesSketch sketch = DoublesSketch.builder().setK(k).build();

while ( remainingValuesExist ) { //stream in all the values, one by one
  sketch.update(nextValue());
}

//Query the sketch with a sorted array of 101 normalized ranks from zero to one: 

double[] normRanks = {0, .01, .02, ... , .99, 1.0}; // Percentiles
double[] values = sketch.getQuantiles(normRanks); //result array of 101 values.
</code></pre></div></div>

<p>When these values are plotted against the normalized ranks we get something like this:</p>

<p><img class="doc-img-full" src="/docs/img/quantiles/DSQsketchK256_StreamA_CDF.png" alt="DSQsketchK256_StreamA_CDF.png" /></p>

<p>In this plot the green dots are the quantiles computed exactly and the red circles are the
results from the quantiles sketch. The two curves on either side of these points represent
the upper and lower bounds returned from the sketch.</p>

<p>This reveals a great deal about the distribution of values in the stream. Just reading from the graph, the median is about 2000 milliseconds and the 90th percentile is about 25,000 and so on. One can also query the min and max values seen by the sketch. By observing the results of the quantiles query, it is not too difficult to create a set of split points for a histogram plot.</p>

<p>In this case the values ranged from one to 1.8 million, which is a little over 6 orders-of-magnitude. (There are zero values in the raw data, which often happens, but they can be ignored in 
this analysis.) In order to plot such a large dynamic range I used a log X-axis and a plot resolution of 5 points per factor of 10. Then I computed 36 equally spaced (on the log axis) split points with values from 1.0 to 1E7. These 36 split points are then provided to the getPMF() function:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>double[] splitpoints = {1.00, 1.58, ... , 6.3E6, 1E7};
double[] pmf = sketch.getPMF(splitpoints);
</code></pre></div></div>

<p>The following histogram is plotted by multiplying all the pmf values by getN(), 
which is the total number of events seen by the sketch (230M). 
The getCDF(…) works similarly, but produces the cumulative distribution instead.</p>

<p><img class="doc-img-full" src="/docs/img/quantiles/TimeSpentHistogram.png" alt="TimeSpentHistogram" /></p>

<p>Now for some fun! For those of you that recognize the shape of this distribution as 
looking remarkably similar to the Normal (Gaussian) Distribution, you are close, but no cigar! 
This data is plotted on a logarithmic axis so it is actually close to a Lognormal Distribution. 
The following plot shows a mathematically generated Lognormal model in red, 
and the actual data distribution in blue as before.<br />
They are remarkably close within about 2 standard deviations on the log axis, but the tails are 
way off.</p>

<p><img class="doc-img-full" src="/docs/img/quantiles/TimeSpentLognormal.png" alt="TimeSpentLognormal" /></p>

<h3 id="more-code-snippets">More Code Snippets</h3>

<p>Code examples are best gleaned from the test code that exercises all the various capabilities of the
sketch.  Here are some brief snippets, simpler than the above graphs, to get you started.</p>

<h4 id="median-and-top-quartile">Median and Top Quartile</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UpdateDoublesSketch qs = DoublesSketch.builder().build(); //default k = 128

for (int i=0; i &lt; 1000000; i++) { //stream length is generally unknown
  qs.update(i); //load the sketch
}

double median = qs.getQuantile(0.5);
double topQuartile = qs.getQuantile(0.75);
System.out.println("Median = " + median);
System.out.println("75%ile = " + topQuartile);

/* Output similar to
Median = 500087.0
75%ile = 749747.0
*/
</code></pre></div></div>

<h4 id="simple-frequency-histogram">Simple Frequency Histogram</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UpdateDoublesSketch qs = DoublesSketch.builder().build(); //default k = 128

for (int i=0; i &lt; 1000000; i++) { //stream length is generally unknown
  qs.update(i); //load the sketch
}

//create a histogram
long n = qs.getN();
double[] splitPoints = {100000, 500000, 900000};

double[] fractionalRanks = qs.getPMF(splitPoints);
int bins = fractionalRanks.length;

double freq;
for (int i=0; i &lt; bins-1; i++) {
  freq = fractionalRanks[i] * n;
  System.out.println(freq + " &lt; "+splitPoints[i]);
}
freq = fractionalRanks[bins-1] * n;
System.out.println(freq + " &gt;= "+ splitPoints[bins-2]);

/* Output similar to
98304.0  &lt;  100000.0
401408.0 &lt;  500000.0
400384.0 &lt;  900000.0
99904.0  &gt;= 900000.0
*/
</code></pre></div></div>

<h4 id="merging-quantile-sketches">Merging Quantile Sketches</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>UpdateDoublesSketch qs1 = DoublesSketch.builder().build(); //default k = 128
UpdateDoublesSketch qs2 = DoublesSketch.builder().build();
long size = 1000000; //generally unknown
for (int i=0; i &lt; size; i++) { //update each value into the sketch
  qs1.update(i);
  qs2.update(i + 1000000);
}

Union union = Union.builder.build(); //creates a virgin Union
union.update(qs1);
union.update(qs2);

DoublesSketch qs3 = union.getResult();
System.out.println(qs3.toString()); //Primarily for debugging

/* Output similar to
### HeapQuantilesSketch SUMMARY: 
   K                            : 128
   N                            : 2,000,000
   Seed                         : 0
   BaseBufferCount              : 128
   CombinedBufferAllocatedCount : 1,920
   Total Levels                 : 13
   Valid Levels                 : 6
   Level Bit Pattern            : 1111010000100
   Valid Samples                : 896
   Buffer Storage Bytes         : 15,360
   Preamble Bytes               : 36
   Normalized Rank Error        : 1.725%
   Min Value                    : 0.000
   Max Value                    : 1,999,999.000
### END SKETCH SUMMARY
*/
</code></pre></div></div>

<h2 id="sketches-core-extending-generic-quantiles-classes"><a name="Section 2"></a>Sketches-Core Extending Generic Quantiles Classes</h2>

<p>Any item type that is comparable, or for which you can create a Comparator, can also be analyzed by extending the abstract generic classes for that particular item.</p>

<p>Suppose you have a massive number of comparable MyItems that you wish to partition in to 10 equal parts for more efficient downstream processing. 
The task is to figure out how to equally partition your data.</p>

<p>First you build a comparator for MyItem:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class MyComparator implements java.util.Comparator&lt;MyItem&gt; {
    @Override
    public int compare(MyItem item1, MyItem item2) {
        //compute equivalent to ...
        return (item1 &lt; item2)? -1 : (item1 &gt; item2)? 1 : 0;
    }
}
</code></pre></div></div>

<p>In distributed or multi-JVM environments you will also need to extend the ArrayOfItemsSerDe base class.
Serialization and deserialization is required to move sketch images across JVMs.
The methods in this class are called by the sketch toByteArray() and sketch constructor as necessary.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.apache.datasketches.ArrayOfItemsSerDe;
import org.apache.datasketches.memory.Memory;

public class ArrayOfMyItemsSerDe extends ArrayOfItemsSerDe&lt;MyItem&gt; {
  
  @Override
  public byte[] serializeToByteArray(MyItem[] items) {
    byte[] byteArr = // hopefully fast and efficient :)
    return byteArr;
  }
  
  @Override
  public MyItem[] deserializeFromMemory(Memory mem, int numItems) {
     //Memory is similar to ByteBuffer, but much more flexible
     // see org.apache.datasketches.memory
     MyItem[] myItemArr = new MyItem[numItems];
     for ( int i = 0; i &lt; numItems; i++ ) {
       //extract each item from mem. See org.apache.datasketches.ArrayOfStringsSerDe example.
       MyItem item = //...
       myItemArr[i] = item;
     }
     return myItemArr;
  }
}
</code></pre></div></div>

<p>You are ready to feed all of MyItems into the sketch:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.apache.datasketches.quantiles.ItemsSketch;

ItemsSketch&lt;MyItem&gt; sketch = ItemsSketch.getInstance(128, new MyComparator());
while ( remainingItemsExist ) {
    sketch.update( nextItem() );
}
</code></pre></div></div>

<p>Then obtain the split point values that equally partition the data into 10 partitions.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>double[] rankFractions = {0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9};
MyItem[] itemSplitPoints = sketch.getQuantiles(rankFractions);
</code></pre></div></div>

<p>Using a simple binary search you can now split your data into the 10 partitions.</p>

<h2 id="implementation-notes"><a name="Section 3"></a>Implementation Notes</h2>

<p>The quantiles algorithm is an implementation of the Low Discrepancy Mergeable Quantiles Sketch, using double values, described in section 3.2 of the journal version of the paper “Mergeable Summaries” by Agarwal, Cormode, Huang, Phillips, Wei, and Yi. 
<a href="http://dblp.org/rec/html/journals/tods/AgarwalCHPWY13"></a> <!-- does not work with https --></p>

<p>This algorithm is independent of the distribution of values, which can be anywhere in the
range of the IEEE-754 64-bit doubles.</p>

<p>This algorithm intentionally inserts randomness into the sampling process for values that
ultimately get retained in the sketch. The result is that this algorithm is not 
deterministic. For example, if the same stream is inserted into two different instances of this 
sketch, the answers obtained from the two sketches may not be be identical.</p>

<p>Similarly, there may be minor directional inconsistencies. For example, the resulting array of 
values obtained from getQuantiles(fractions[]) input into the reverse directional query 
getPMF(splitPoints[]) may not result in the original fractional values.</p>

      </div>
    </div>
  </div>

  <!-- Start page_footer.html include -->
<footer class="ds-footer">
  <div class="container">
    <div class="text-center">
      <p>
        <a href="/overview.html">
          <span class="fa fa-info-circle"></span> Overview</a>&ensp;·&ensp;
        <a href="/docs/downloads.html">
          <span class="fa fa-download"></span> Download</a>&ensp;·&ensp;
        <a href="https://github.com/apache?utf8=%E2%9C%93&q=datasketches">
          <span class="fa fa-github"></span> GitHub</a>&ensp;·&ensp;
        <a href="https://groups.google.com/forum/#!forum/sketches-user">
          <span class="fa fa-comment"></span> Comments</a>&ensp;·&ensp;
        <a href="https://github.com/DataSketches/DataSketches.github.io/blob/master/LICENSE">Licensing</a>
      </p>
    </div>
  </div>
</footer>
<!-- End page_footer.html include -->

</body>

</html>
<!-- End _layouts/doc_page.html-->
